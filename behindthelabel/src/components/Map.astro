---
import "leaflet/dist/leaflet.css";
---

<div id="map"></div>

<script>
    import L from "leaflet";

    const map = L.map("map", {
        center: [50.8285, 3.264],
        zoom: 13,
        zoomControl: true,
        touchZoom: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: false,
        keyboard: true,
        dragging: true,
        tapTolerance: 15,
        trackResize: true,
        worldCopyJump: false,
        closePopupOnClick: true,
        zoomSnap: 1,
        zoomDelta: 1,
    });

    // Add CSS for grayscale tiles
    const style = document.createElement("style");
    style.textContent = `
        .grayscale-tiles {
            filter: grayscale(100%) contrast(95%) brightness(95%);
        }
        #map {
            touch-action: none;
        }
    `;
    document.head.appendChild(style);

    let selectedMarker: any = null;

    function slugify(input: any) {
        return String(input || "")
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "-")
            .replace(/[^\w-]/g, "");
    }

    function computeSlug(feature: any) {
        return (
            feature.properties.slug ||
            feature.properties.id ||
            (feature.properties.link ? slugify(feature.properties.link) : "")
        );
    }

    function artworkIcon(feature: any, isSelected = false) {
        const isFeatured = feature.properties.featured;
        const image = feature.properties.image;

        return L.divIcon({
            className: "artwork-marker",
            html: `
          <div class="artwork-marker-inner ${isFeatured ? "featured" : ""} ${isSelected ? "is-selected" : ""}">
            <img src="${image || "/behindthelabel/assets/markers/marker__gray.svg"}" class="artwork-thumb" />
            <div class="artwork-pin"></div>
          </div>
        `,
            iconSize: [80, 80],
            iconAnchor: [40, 80],
            popupAnchor: [0, -80],
        });
    }

    function updateMarkerIcon(layer: any, isSelected: any) {
        const feature = layer.feature;
        const newIcon = artworkIcon(feature, isSelected);
        layer.setIcon(newIcon);
    }

    // read target slug from the current URL if present: /.../artworks/:slug
    function getTargetSlugFromPath() {
        const parts = window.location.pathname
            .replace(/\/$/, "")
            .split("/")
            .filter(Boolean);
        const idx = parts.indexOf("artworks");
        if (idx !== -1 && parts.length > idx + 1) {
            return decodeURIComponent(parts[idx + 1]);
        }
        return null;
    }

    const targetSlug = getTargetSlugFromPath();

    fetch("/behindthelabel/data/KPR+Kortrijk.geojson")
        .then((r) => r.json())
        .then((data) => {
            // Create geoJSON layer directly (without clustering for compatibility)
            const geo = L.geoJSON(data, {
                pointToLayer: (feature, latlng) => {
                    if (feature.properties.image) {
                        return L.marker(latlng, { icon: artworkIcon(feature) });
                    }

                    const isFeatured = feature.properties.featured;
                    const customIcon = L.icon({
                        iconUrl: isFeatured
                            ? "/behindthelabel/assets/markers/marker__yellow.svg"
                            : "/behindthelabel/assets/markers/marker__gray.svg",
                        iconSize: isFeatured ? [24, 24] : [18, 18],
                        iconAnchor: isFeatured ? [12, 24] : [9, 18],
                        popupAnchor: isFeatured ? [0, -24] : [0, -18],
                    });
                    return L.marker(latlng, { icon: customIcon });
                },

                onEachFeature(feature: any, layer: any) {
                    layer.feature = feature;
                    const coords = feature.geometry.coordinates;
                    const routeUrl = `https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}`;

                    const slug = computeSlug(feature);
                    const detailUrl = slug
                        ? `/behindthelabel/artworks/${encodeURIComponent(slug)}`
                        : null;

                    // hide "Details" when we're already on that artwork's detail page
                    let detailsLink = "";
                    if (!(targetSlug && slug && targetSlug === slug)) {
                        detailsLink = detailUrl
                            ? `<a href="${detailUrl}" class="card-button" style="margin-left:0.5rem;" title="Open detail page">See story</a>`
                            : "";
                    }
                    const popupHtml = `
        <div class="card">
            <div class="card-place">
                ${feature.properties.location || ""}
            </div>
            <div class="card-body">
                ${
                    feature.properties.image
                        ? `<img src="${feature.properties.image}" class="card-image" />`
                        : ""
                }
                <div class="card-title">${feature.properties.name}</div>
                <div class="buttons">
                <a href="${routeUrl}" target="_blank" class="card-button route-button">
                    See route
                </a>
                ${detailsLink}
                </div>
            </div>
        </div>
    `;

                    const popupOptions = {
                        closeButton: true,
                        autoPan: true,
                    };

                    layer.bindPopup(popupHtml, popupOptions);

                    layer.on("click", () => {
                        if (selectedMarker) {
                            updateMarkerIcon(selectedMarker, false);
                        }
                        selectedMarker = layer;
                        updateMarkerIcon(selectedMarker, true);
                    });
                },
            });

            // Add geo layer directly to map
            map.addLayer(geo);

            // If we are on a detail page for an artwork, open its popup
            if (targetSlug) {
                let opened = false;
                geo.eachLayer((layer: any) => {
                    if (!layer.feature) return;
                    const slug = computeSlug(layer.feature);
                    if (slug && slug === targetSlug) {
                        layer.openPopup();
                        if (selectedMarker)
                            updateMarkerIcon(selectedMarker, false);
                        selectedMarker = layer;
                        updateMarkerIcon(selectedMarker, true);

                        if (layer.getLatLng) {
                            map.setView(
                                layer.getLatLng(),
                                Math.max(map.getZoom(), 15),
                                { animate: true },
                            );
                        }
                        opened = true;
                    }
                });

                if (!opened) {
                    console.info("No matching artwork for slug", targetSlug);
                }
            }
        });
</script>

<style>
    :global(.card) {
        width: 11rem;
        background: #1b1b1b;
        border-radius: 0.75rem;
        overflow: hidden;
        padding-bottom: 1rem;
        font-family: Obviously, sans-serif;
    }

    :global(.card-place) {
        background: #ff6249;
        color: white;
        text-align: center;
        font-size: 2rem;
        font-weight: 450;
        padding: 0.7rem 0;
    }

    :global(.card-body) {
        padding: 1rem;
        text-align: center;
    }

    :global(.card-image) {
        width: 100%;
        height: 6rem;
        object-fit: contain;
        margin-bottom: 1rem;
    }

    :global(.card-title) {
        color: white;
        font-size: 1rem;
        font-weight: 560;
        margin-bottom: 1rem;
    }

    :global(.card-button) {
        display: inline-block;
        padding: 0.4rem 1rem;
        background: #d4f75f;
        border: 2px solid #1b1b1b;
        font-size: 1rem;
        font-weight: 500;
        color: #1b1b1b;
        text-decoration: none !important;
        outline: 5px solid #d4f75f;
        border-radius: 0.25rem;
        margin: 0.5rem;
    }

    :global(.leaflet-popup-content-wrapper) {
        background: transparent;
        box-shadow: none;
        border-radius: 0.75rem;
        padding: 0;
    }

    :global(.leaflet-popup-content) {
        margin: 0;
        padding: 0;
    }

    :global(.leaflet-tile) {
        filter: grayscale(100%) contrast(95%) brightness(95%);
    }

    :global(.artwork-marker-inner) {
        position: relative;
        display: inline-block;
    }

    :global(.artwork-thumb) {
        width: 90px;
        height: 70px;
        object-fit: cover;
        border-radius: 0.5rem;
        margin-bottom: 20px;
    }

    :global(.artwork-pin) {
        position: absolute;
        left: 50%;
        width: 24px;
        height: 32px;
        bottom: -10px;
        transform: translateX(-50%);
        background: url("/behindthelabel/assets/markers/marker__yellow.svg")
            center/contain no-repeat;
    }

    :global(.artwork-marker-inner.is-selected .artwork-pin) {
        background: url("/behindthelabel/assets/markers/marker__orange.svg")
            center/contain no-repeat;
    }

    :global(.leaflet-popup-tip) {
        background-color: #1b1b1b;
    }

    :global(.route-button) {
        background-color: #1b1b1b;
        border: 2px solid #d4f75f;
        outline: none;
        border-radius: 0;
        color: #1b1b1b;
    }
</style>
